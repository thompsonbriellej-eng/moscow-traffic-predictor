<script>
// Robust dropdown wiring: safe to run even if elements load slowly or are missing.
(function(){
  // Guard: ensure CITY_DB exists
  if(typeof CITY_DB === 'undefined'){ console.warn('CITY_DB missing'); window.CITY_DB = {}; return; }

  const countrySelect = document.getElementById('countrySelect');
  const citySelect = document.getElementById('citySelect');

  if(!countrySelect || !citySelect){
    console.error('Dropdown elements missing: countrySelect or citySelect not found in DOM.');
    return;
  }

  // Populate countries sorted
  function populateCountries(){
    countrySelect.innerHTML = '';
    const countries = Object.keys(CITY_DB).sort();
    for(const c of countries){
      const opt = document.createElement('option');
      opt.value = c;
      opt.innerText = c;
      countrySelect.appendChild(opt);
    }
  }

  // Populate cities for selected country
  function populateCities(){
    const country = countrySelect.value || countrySelect.options[0]?.value;
    citySelect.innerHTML = '';
    const list = (CITY_DB[country] || []);
    if(list.length === 0){
      const opt = document.createElement('option'); opt.value='-'; opt.innerText = 'No cities available'; citySelect.appendChild(opt); return;
    }
    for(const ct of list){
      const opt = document.createElement('option');
      opt.value = ct.id;
      opt.innerText = ct.name;
      citySelect.appendChild(opt);
    }
  }

  // Ensure we initialize only after DOM content loaded
  function initOnce(){
    populateCountries();
    // if no country selected, pick first
    if(!countrySelect.value && countrySelect.options.length>0) countrySelect.value = countrySelect.options[0].value;
    populateCities();
  }

  // Wire events with debounce to avoid double calls
  let t=null;
  countrySelect.addEventListener('change', ()=>{ clearTimeout(t); t=setTimeout(populateCities,50); });
  citySelect.addEventListener('change', ()=>{ /* optional: place hook if needed */ });

  // In case the script loads before DOM (rare), wait for DOMContentLoaded
  if(document.readyState === 'loading'){
    document.addEventListener('DOMContentLoaded', initOnce);
  } else {
    initOnce();
  }

  // expose functions for debugging in console
  window.__mt_populateCountries = populateCountries;
  window.__mt_populateCities = populateCities;
})();
</script>
